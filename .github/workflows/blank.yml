name: export-and-branch-solution
# Export solution from DEV environment
# Unpack it and prepare, commit and push a git branch with the changes

on:
  workflow_dispatch:
    inputs:
      # IMPORTANT: Use the solution's *unique name* (not display name)
      solution_name:
        description: 'Unique name of the solution to export (no spaces)'
        required: true
        default: GithubApp
      # Do not change these values
      solution_exported_folder:
        description: 'folder name for staging the exported solution *do not change*'
        required: true
        default: out/exported/
      solution_folder:
        description: 'staging the unpacked solution folder before check-in *do not change*'
        required: true
        default: out/solutions/
      solution_target_folder:
        description: 'folder name to be created and checked in *do not change*'
        required: true
        default: solutions/

#edit your values here
  ENVIRONMENT_URL: https://orgc9b19932.crm11.dynamics.com/
  CLIENT_ID: 717226da-1708-458e-b56a-559e3a991cc3
  TENANT_ID: 21f86a55-b21d-41aa-b173-656614ff35d9
permissions:
  contents: write

jobs:
  export-from-dev:
    runs-on: windows-latest        # or ubuntu-latest
    timeout-minutes: 60            # optional: more headroom for transient retries
    env:
      RUNNER_DEBUG: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Power Platform Tools
        uses: microsoft/powerplatform-actions/actions-install@v1

      - name: WhoAmI (SPN)
        uses: microsoft/powerplatform-actions/who-am-i@v1
        with:
          environment-url: ${{ env.ENVIRONMENT_URL }}
          application-id: ${{ env.CLIENT_ID }}
          tenant-id:       ${{ env.TENANT_ID }}
          client-secret:   ${{ secrets.PowerPlatformSPN }}

      - name: Export solution
        uses: microsoft/powerplatform-actions/export-solution@v1
        with:
          environment-url:      ${{ env.ENVIRONMENT_URL }}
          application-id:       ${{ env.CLIENT_ID }}
          tenant-id:            ${{ env.TENANT_ID }}
          client-secret:        ${{ secrets.PowerPlatformSPN }}
          solution-name:        ${{ github.event.inputs.solution_name }}
          solution-output-file: ${{ github.event.inputs.solution_exported_folder }}${{ github.event.inputs.solution_name }}.zip

      - name: Unpack solution
        uses: microsoft/powerplatform-actions/unpack-solution@v1
        with:
          solution-file:   ${{ github.event.inputs.solution_exported_folder }}${{ github.event.inputs.solution_name }}.zip
          solution-folder: ${{ github.event.inputs.solution_folder }}${{ github.event.inputs.solution_name }}
          solution-type:   'Unmanaged'
          overwrite-files: true

      - name: Branch solution (prepare for PR)
        uses: microsoft/powerplatform-actions/branch-solution@v1
        with:
          solution-folder:        ${{ github.event.inputs.solution_folder }}${{ github.event.inputs.solution_name }}
          solution-target-folder: ${{ github.event.inputs.solution_target_folder }}${{ github.event.inputs.solution_name }}
          repo-token:             ${{ secrets.GITHUB_TOKEN }}
          allow-empty-commit:     true
